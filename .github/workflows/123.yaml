name: itvlist 123

on:
  schedule:
    - cron: '0 21 * * *'  # UTCæ—¶é—´21ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥5ç‚¹ï¼‰
  push:
    branches:
      - main

# å…³é”®ä¿®å¤ï¼šæ·»åŠ å†™å…¥æƒé™
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # é‡è¦ï¼šæ·»åŠ tokené…ç½®
          token: ${{ secrets.GITHUB_TOKEN }}
          # è·å–å®Œæ•´å†å²è®°å½•
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'  # å»ºè®®æŒ‡å®šå…·ä½“ç‰ˆæœ¬

      - name: Install dependencies
        run: |
          pip install selenium requests futures eventlet
          # æ·»åŠ Chromedriverç”¨äºselenium
          sudo apt-get update
          sudo apt-get install -y chromium-chromedriver

      - name: Run itv_all
        run: |
          cd ${{ github.workspace }}
          python itv_all.py

      #- name: Run cctv
        #run: python cctv.py
        
      #- name: Run weishi
        #run: python weishi.py
        
      #- name: Run qita
        #run: python qita.py

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check-changes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜æ›´
          if git status --porcelain | grep -q '\.\(txt\|m3u\)$'; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´:"
            git status --porcelain | grep '\.\(txt\|m3u\)$'
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ğŸŸ¡ æ²¡æœ‰æ£€æµ‹åˆ°txtæˆ–m3uæ–‡ä»¶å˜æ›´"
          fi

      - name: é…ç½®Git
        run: |
          git config --local user.email "ssili@126.com"
          git config --local user.name "ssili126"

      - name: æäº¤æ›´æ”¹
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          # åªæ·»åŠ txtå’Œm3uæ–‡ä»¶
          git add *.txt *.m3u || echo "æ²¡æœ‰æ‰¾åˆ°txt/m3uæ–‡ä»¶"
          
          # æäº¤å˜æ›´
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°: $(date +'%Y-%m-%d %H:%M:%S')" || exit 0
          
          # æ¨é€å˜æ›´ï¼ˆä¸ä½¿ç”¨å¼ºåˆ¶æ¨é€ï¼‰
          git pull --rebase origin main
          git push origin main
        env:
          # ä½¿ç”¨tokenè¿›è¡Œè®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
